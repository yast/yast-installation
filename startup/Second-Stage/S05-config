#!/bin/sh
log "Starting S05-config..."
log "======================"

#=============================================
# 8) provide configurations
#---------------------------------------------
# 8.1) /etc/sysconfig hotplug...
if [ -f $HTPLG_SYS ] ; then
	HTPLG_TMP=`mktemp /tmp/hotplug.XXXXXX`
	HTPLG_SYS=/etc/sysconfig/hotplug
	if [ -f $HTPLG_TMP ] ; then
		# /.../
		# Do we have USB? If yes set HOTPLUG_START_USB to yes, else to no.
		# !! variable USB is also used later in this script, don't change this
		# ---
		USB=no
		lspci -n 2>/dev/null| grep -q "Class[[:space:]]*0c03" && USB=yes
		cp $HTPLG_SYS $HTPLG_TMP
		sed -e "s/^[[:space:]]*\(H.*G_START_USB\).*$/\1=$USB/" \
			$HTPLG_TMP > $HTPLG_SYS
		# /.../
		# Do we need hotplug for PCI? Yes, if we use kernel pcmcia.
		# But we don't set anything to no here, just leave it alone
		# ---
		eval `grep PCMCIA_SYSTEM /etc/sysconfig/pcmcia 2>/dev/null`
		if [ "$PCMCIA_SYSTEM" = kernel ] ; then
			cp $HTPLG_SYS $HTPLG_TMP
			sed -e "s/^[[:space:]]*\(H.*G_START_NET\).*$/\1=yes/" \
				-e "s/^[[:space:]]*\(H.*G_START_PCI\).*$/\1=yes/" \
			$HTPLG_TMP > $HTPLG_SYS
		fi
		rm -f $HTPLG_TMP
		log "\tCreating hotplug configuration..."
		IFS_SAVE=$IFS
		IFS="
		"
		while read line;do
			log "\t$line"
		done < $HTPLG_SYS
		IFS=$IFS_SAVE
	fi
fi

#=============================================
# 8.2) /etc/fstab refering to USB and hotplug
#---------------------------------------------
if [ -x /etc/init.d/hotplug -a "$USB" = yes ];then
	FSTAB_TMP=`mktemp /tmp/fstab.XXXXXX`
	FSTAB=/etc/fstab
	WRITE=yes
	if [ -f $FSTAB_TMP ];then
		cp $FSTAB $FSTAB_TMP
		while read DEV MP FST OPT REST; do
			LINE="$DEV $MP $FST $OPT $REST"
			case "$DEV" in
			none|usbdevfs|usbfs)
				if [ "$MP" = "/proc/bus/usb" -a "$OPT" != "noauto" ];then
					echo "# $LINE"
					WRITE=yes
				else
					echo "$LINE"
					WRITE=no
				fi
			;;
			*)
				echo "$LINE"
			;;
			esac
		done < $FSTAB_TMP > $FSTAB
		if [ "$WRITE" = yes ] ; then
			echo -e "usbfs\t/proc/bus/usb\tusbfs\tnoauto 0 0"
		fi >> $FSTAB
		rm -f $FSTAB_TMP
		log "\tCreating fstab configuration..."
		IFS="
		"
		while read line;do
			log "\t$line"
		done < $FSTAB
		IFS=$IFS_SAVE
	fi
fi

#=============================================
# 8.3) ifcfg-pcmcia and ifcfg-usb
#---------------------------------------------
if [ -x /etc/init.d/pcmcia -o -x /etc/init.d/hotplug ];then
	IFCFG_PCMCIA=/etc/sysconfig/network/ifcfg-pcmcia
	IFCFG_USB=/etc/sysconfig/network/ifcfg-usb
	rm -f $IFCFG_PCMCIA_SAVE
	rm -f $IFCFG_USB_SAVE
	test -f "$IFCFG_PCMCIA" && mv $IFCFG_PCMCIA $IFCFG_PCMCIA_SAVE
	test -f "$IFCFG_USB" && mv $IFCFG_USB $IFCFG_USB_SAVE
	echo "STARTMODE=hotplug" > $IFCFG_PCMCIA
	echo "BOOTPROTO=static" >> $IFCFG_PCMCIA
	while read a b c d; do
	case $a in
		IP:) echo "IPADDR=$b" ;;
		Netmask:) echo "NETMASK=$b" ;;
		Broadcast:) echo "BROADCAST=$b" ;;
	esac
	done < /etc/install.inf >> $IFCFG_PCMCIA
	cp $IFCFG_PCMCIA $IFCFG_USB
	log "\tCreating network configurations for PCMCIA/USB cards..."
	IFS="
	"
	while read line;do
		log "\t$line"
	done < $IFCFG_PCMCIA
	IFS=$IFS_SAVE
fi

